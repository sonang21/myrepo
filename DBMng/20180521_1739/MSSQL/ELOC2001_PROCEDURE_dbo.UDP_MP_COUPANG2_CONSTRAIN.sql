/* *************************************************************************
 * NAME : dbo.UDP_MP_COUPANG2_CONSTRAIN
 * TYPE : PROCEDURE (SQL_STORED_PROCEDURE)
 * TIME : Create: 2016-06-02 10:10:08.133
 *        Modify: 2018-05-16 10:58:49.387
 *        Backup: 20180521_1739
 ************************************************************************* */


CREATE PROC [DBO].[UDP_MP_COUPANG2_CONSTRAIN]
AS
BEGIN
	SET NOCOUNT ON;
	SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
	
	-- 23시 실행
	DECLARE @MODELNO INT
	DECLARE @QRY VARCHAR(8000)

	SELECT G_MODELNO
	INTO #GOODS
	FROM GOODS
	WHERE G_IMGCHK = '4' AND G_CONSTRAIN <> '6' AND G_MODELNO IN (
		SELECT DISTINCT JG_MODELNO
		FROM LOGDB.DBO.JOB_GOODS
		WHERE JG_FLAG = '0' AND JG_ID NOT LIKE '%_AUTO%')
		--FROM OLTPLOG_196.OLTPLOG.DBO.JOB_GOODS
		--WHERE JG_FLAG = '0' AND JG_DATE >= '2016-05-31' AND JG_ID NOT LIKE '%_AUTO%')
	  AND EXISTS (SELECT TOP 1 1 FROM PRICELIST WHERE PL_VCODE IN (7863,7876,7877,7878,7879,7880,7881,7882,7883,7884,7913,7914,7915,7916,7917,7918,7919,7920,7921,7922,7923,7924,7925,7926,7927) AND PL_MODELNO = G_MODELNO)
	OPTION (MAXDOP 1)
	
	DECLARE FETCH_CURSOR CURSOR FOR
	SELECT G_MODELNO
	FROM #GOODS

	OPEN FETCH_CURSOR

	FETCH NEXT FROM FETCH_CURSOR INTO @MODELNO
	WHILE @@FETCH_STATUS = 0
	BEGIN
		UPDATE GOODS
		SET G_FLAG = '0', G_CONSTRAIN = '6'
		WHERE G_MODELNO = @MODELNO
		
		-- 분산큐(GOODS)
		INSERT INTO?TB_MODEL_CHG_HST(MODEL_NO, PGM_ID, DAT_CHG_DCD, FRW_YN, ORGN_DTM)
????	VALUES (@MODELNO, 'db_proc', 'U', 'N', GETDATE())
		
		FETCH NEXT FROM FETCH_CURSOR INTO @MODELNO
	END

	CLOSE FETCH_CURSOR
	DEALLOCATE FETCH_CURSOR
END
